# v0.8.0-rc1 - Development Version - FAST BUILD
FROM node:20-bullseye-slim

# Install dependencies required for build
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    build-essential \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files first for better caching
COPY package*.json ./
COPY api/package*.json ./api/
COPY client/package*.json ./client/
COPY packages/data-provider/package*.json ./packages/data-provider/
COPY packages/data-schemas/package*.json ./packages/data-schemas/
COPY packages/api/package*.json ./packages/api/

# Install dependencies with minimal configuration
RUN npm install --no-audit --prefer-offline

# Install API workspace dependencies separately
RUN cd api && npm install --no-audit --prefer-offline

# Copy source code
COPY . .

# Build only essential packages
RUN npm run build:data-provider && npm run build:data-schemas

# Create required directories
RUN mkdir -p /app/client/public/images /app/api/logs

EXPOSE 3080

ENV NODE_ENV=development
ENV HOST=0.0.0.0

CMD ["node", "api/server/index.js"]