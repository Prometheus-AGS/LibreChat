# LibreChat Artifact Function

This document explains how artifacts are generated, validated, streamed, and rendered in LibreChat, and where the prompting logic and key modules live.

## Overview

- __Purpose__: Artifacts are substantial, self-contained pieces of content generated by the model and shown in a dedicated UI pane (code, HTML pages, mermaid diagrams, simple React components, etc.).
- __Format__: The model emits artifacts using a remark-directive block:
  ```md
  :::artifact{identifier="unique-id" type="mime-type" title="Descriptive Title"}
  ```
  <artifact content>
  ```
  :::
  ```
- __Lifecycle__: Prompting → Model emits artifact blocks → Server parses/updates/validates → Client renders/sandboxes → User iterates by sending new messages that update the same `identifier`.

## Prompting and Allowed Types

- __Primary prompt source__: `api/app/clients/prompts/artifacts.js`
  - Exposes prompt templates such as `artifactsPrompt` and `artifactsOpenAIPrompt` that instruct the model how and when to produce artifacts, the exact markdown shape, and allowed libraries.
  - References shadcn docs helpers under `api/app/clients/prompts/shadcn-docs/` for component guidance.
- __Core rules__ (summarized):
  - One artifact per message unless requested otherwise.
  - Use artifacts only for substantial, self-contained content.
  - Always include full, runnable content (no ellipses or placeholders).
  - Use the correct `type`, e.g.:
    - `text/html` — single-file HTML/CSS/JS; external scripts only via cdnjs; web images disallowed, use `/api/placeholder/<w>/<h>`.
    - `image/svg+xml` — SVG content with `viewBox` preferred over fixed width/height.
    - `application/vnd.mermaid` — Mermaid diagram content.
    - `application/vnd.react` — React elements or components; default export; Tailwind for styling; limited, whitelisted imports.
  - Use a stable, kebab-case `identifier` for subsequent updates.

## Server-Side Flow

- __Artifacts service__: `api/server/services/Artifacts/`
  - `update.js`: Applies/merges artifact updates from model responses into the conversation/message state.
  - `index.js`: Service exports and wiring.
- __Validation pipeline__: `api/server/services/ArtifactValidation/`
  - `VirtualFileSystem.js`: In-memory VFS to assemble artifact files for validation/execution (e.g., React/TypeScript).
  - `TypeScriptValidator.js`: Compiles and validates TS/React artifacts; reports errors with locations.
  - `RetryManager.js`: Orchestrates validation retries and backoff when compilation fails.
  - `StreamingFeedback.js`: Streams validation status and diagnostics back to the client during message generation.
  - `ErrorFormatter.js`: Normalizes diagnostics for user-friendly feedback.
  - `config.js`, `middleware.js`: Configuration and Express integration for the validation flow.

Flow summary:
1) Model response includes `:::artifact{...}` blocks as instructed by the prompts.
2) Server parses artifact blocks and calls `Artifacts/update` to persist/update artifact data tied to the message and `identifier`.
3) For eligible types (e.g., React/TS), content is loaded into the `VirtualFileSystem` and validated by `TypeScriptValidator`.
4) `StreamingFeedback` emits progressive status/errors to the frontend; `RetryManager` may attempt fixes/retries depending on settings.

## Client-Side Rendering and State

- __Components__: `client/src/components/Artifacts/`
  - `Artifacts.tsx`: High-level container switching between tabs/previews/editors and wiring to conversation state.
  - `Artifact.tsx`, `ArtifactPreview.tsx`, `ArtifactCodeEditor.tsx`, `ArtifactTabs.tsx`, `DownloadArtifact.tsx`, `Mermaid.tsx`.
- __Context__: `client/src/Providers/ArtifactsContext.tsx`
  - Provides `isSubmitting`, `latestMessageId`, `latestMessageText`, and `conversationId` for artifact UIs to react to chat flow.
- __Hooks/Store__:
  - `client/src/hooks/Artifacts/useArtifacts.ts`
  - `client/src/store/artifacts.ts`
- __Sandbox and utilities__: `client/src/utils/artifacts.ts`
  - Configures the Sandpack/iframe environment, external resources, and security constraints for rendering artifacts.
  - Note: By default, images from arbitrary external URLs are restricted; see configuration below for enabling safe previews.
- __Shared types__: `client/src/common/artifacts.ts`
  - `Artifact`, `CodeBlock`, and `ArtifactFiles` shape used across the UI.

## Security and Sandboxing

Artifacts render in a sandboxed environment to prevent arbitrary code execution.

- __File__: `client/src/utils/artifacts.ts`
  - Defines Sandpack options (external resources, CSP/sandbox flags) for artifact previews.
  - To permit external images or other resources, adjust `sharedOptions` carefully (see `docs/artifacts-import-fix.md` for examples and rationale).
- __Server validation__ helps catch compile-time issues early for `application/vnd.react` artifacts, reducing runtime surprises.

## Updating Artifacts by Identifier

- Each artifact includes an `identifier` attribute which should remain stable across iterations.
- When the user asks to “update” or “modify” prior content, the model should emit a new artifact block using the same `identifier` and include the full, updated content.
- The server merges the update via `api/server/services/Artifacts/update.js`, preserving history by message while allowing the UI to show the latest.

## Allowed Imports and Libraries (React artifacts)

Per `api/app/clients/prompts/artifacts.js`:
- React base APIs are available (e.g., `import { useState } from "react"`).
- Tailwind classes allowed (avoid arbitrary values like `h-[600px]`).
- `lucide-react` (version pinned in prompts), `recharts`, `three`, `date-fns`, and `react-day-picker` are allowed.
- `shadcn/ui` components are importable from `/components/ui/<name>` only; mention to the user if used.
- `cn` utility must be imported as `import { cn } from "/lib/utils"`.
- No other libraries should be imported.

## Configuration Knobs

- __Prompts__: Tweak artifact instructions in `api/app/clients/prompts/artifacts.js`. Exports are fed into provider-specific client setup.
- __Validation__: Adjust thresholds/retry rules in `api/server/services/ArtifactValidation/config.js` and related middleware.
- __Sandbox__: Tune `client/src/utils/artifacts.ts` to allow or restrict external resources (CSP, sandbox flags, CDNs).

## Extending Artifact Types

1) Update prompt docs to teach the model a new `type`:
   - Add guidance to `api/app/clients/prompts/artifacts.js` under the type list.
2) Add/adjust server parsing and validation if needed:
   - Extend `ArtifactValidation` to handle new compilation or linting needs.
3) Add rendering support on the client:
   - Create a renderer component in `client/src/components/Artifacts/` and wire it into `Artifacts.tsx`.
4) Update sandbox constraints in `client/src/utils/artifacts.ts` as required.

## Troubleshooting

- __Artifacts not rendering__:
  - Check browser console for sandbox/CSP errors.
  - Verify `type` matches one of the supported handlers.
  - Ensure the artifact content is complete (no truncated code).
- __React artifact compile errors__:
  - See streamed diagnostics from `TypeScriptValidator` and `StreamingFeedback`.
  - Confirm import paths exactly match prompt guidance (e.g., `"/lib/utils"`, `/components/ui/...`).
- __External images blocked__:
  - Adjust `sharedOptions` in `client/src/utils/artifacts.ts` to allow `img-src` from specific domains. See `docs/artifacts-import-fix.md`.

## Key Files and Directories

- __Prompts__
  - `api/app/clients/prompts/artifacts.js`
  - `api/app/clients/prompts/shadcn-docs/*`
- __Server__
  - `api/server/services/Artifacts/` — persistence/update wiring
  - `api/server/services/ArtifactValidation/` — VFS, TS validation, retries, streaming feedback, config
- __Client__
  - `client/src/components/Artifacts/*` — UI renderers and editors
  - `client/src/Providers/ArtifactsContext.tsx` — context with latest message state
  - `client/src/utils/artifacts.ts` — sandbox/CSP options
  - `client/src/common/artifacts.ts` — shared types

## How It Fits in the Chat Loop

1) User sends a request that warrants an artifact.
2) The system includes artifact prompts (from `artifacts.js`) in the provider call.
3) The model replies with an artifact block.
4) Server parses and validates; issues streamed feedback.
5) Client renders the artifact in the Artifacts panel. Subsequent user requests can iterate using the same `identifier`.
